算法：
1.二维数组，顺时针打印
2.二叉树中序遍历，不用递归实现
3.给定微服务集群中的调用关系，例如：[('A', 'B'), ('B', 'C'), ('C', 'D'), ('D', 'A')]，看是否存在循环调用。
4.将数组分割成k组，长度差不超过1
5.给定一组非负整数，重新排列它们的顺序使之组成一个最大的整数
6.根号2算法怎么去计算，如果说不同适用根号2的话，手写一个算法，计算他的结果值。
7.类似于单向链表的数据结构题型
8.输入一个数字，按如下打印出对应的矩阵，如输入4
1  2  6  7
3  5  8  13
4  9  12 14
10 11 15 16
9.36进制加法
10.	判断一个二叉数是否是另一个二叉树的子树
11.	算法:从链表中删去总和值为零的连续节点。
12.	定一个不重复的字符[abcd]，以及一个长度为n的字符串
13.	tibcacbdata，问能否在这个字符串中找到一个长度为m的连续子串，使得这个子崇刚好由上面m个字符组成，顺序无所谓，返回任意满足条件的一个子串的起始位置，未找到返回-1，时间复杂度On，比如上面这个例子，acbd，3。
14.	间隔k位反转链表。
15.	算法题：二叉树Z字打印。
16.	算法题：两个链表相乘，1->9->null,3->2->null 返回 6->0->8 不能遍历后变成整数直接计算。
17.	旋转数组
第一面算法：
18.	约瑟夫问题：https://blog.csdn.net/longintchar/article/details/75150621
第二面算法：
19.	旋转数组问题，
leetcode原题：https://leetcode.cn/problems/search-in-rotated-sorted-array/
20.	第三面算法：
二叉树Z型层序遍历：https://blog.csdn.net/sunnnnh/article/details/116515818
21.顺时针打印矩阵https://leetcode.cn/problems/shun-shi-zhen-da-yin-ju-zhen-lcof/
22.给定一个升序整型数组，如[1,2,2,3,4,5,5,6]，给定一个target，找到开始index和结束index，如target=2返回[1,2]，target=3返回[3,3]，如果target不存在，则返回[-1,-1]，如target=7返回[-1,-1]。
https://leetcode.cn/problems/find-first-and-last-position-of-element-in-sorted-array/
23.leetcode原题https://blog.csdn.net/qq_41303708/article/details/115030735。
24.之字形层序遍历的算法题。
25.给一个正整数n，一个数组，从数组里面挑选，组成一个比n要小的最大数。（架构leader）
26.
给了一个字符串解析的算法，1-26代表a-z，然后给一串数字求解法种数
27.	链表按K组反转（frank，三面）、
28.	给一个整数数组，取一个峰值，要求时间复杂度是logn，n是数组长度。
29.	https://leetcode.cn/problems/longest-substring-without-repeating-characters/solutions/3982/hua-dong-chuang-kou-by-powcai/
30.	一面：翻转链表
31.	二面：判断一个二叉树是不是另一个二叉树的子树
32.	判断一个树结构是不是子树
33.	三面算法题：36制加法
34.	两棵二叉树，寻找他们共同子结构，给出相同子结构的节点数量。（判断一个树结构是不是子树。升级版，先从一个树里面找子树，挨个去判断是不是另一棵树的子结构 ）
35.	二叉树子树判断
36.	树的非叶子节点数值统计求和
37.	：leetcode原题，74: 搜索二维矩阵。
38.	https://leetcode.cn/problems/longest-substring-without-repeating-characters/（鹿七）
39.	https://leetcode.cn/problems/reverse-words-in-a-string-iii/9（一面）
40.	就是那个找最长不重复子串的问题。https://leetcode.cn/problems/zui-chang-bu-han-zhong-fu-zi-fu-de-zi-zi-fu-chuan-lcof/



设计题：
1.有学生老师 课程，一个学生可以选择多个课程一个老师也可以教多个课程，提供这个数据结构的解决方案
所有的学生一起抢一个课程，需要去保证公平性，一致性，实时性这三个的解决方案。
2.	分布式限流
3.	分布式调度系统
4.	
设计一个分布式任务调度系统，模型如何设计？核心api如何设计
addTask 添加任务
addDependence 添加依赖
fetchTask 获取任务，只能获取没有依赖，或依赖已全部执行完的
executeTask 执行任务
如何分库分表，addTask和addDependence会有跨库依赖问题吗？fetchTask会有会有跨库依赖问题吗？问题严重吗？如何处理跨库依赖问题
设计题还有一个问题：executeTask如何跨节点执行
4.介绍下怎么实现流式处理里面的双流JOIN。
5.文件网关设计（指标、容错、时效性、高可用）
异地多活架构设计
5.	高考查分数，选用什么数据库，等等。
6.	抖音上购买电影票，在一个事务中，以下三条SQL语句要怎么排列呢
 1.从顾客A账户余额中扣除电影票价；
 2.给影院平台B账户余额增加这张电影票价；
3.记录一条交易日志。
7.	直播打赏系统（多次考）
8.	金币管理系统

八股文：
1.mysql隔离级别有哪些
2.
3.一致性视图怎么实现的
4.Redis缓存雪崩和缓存击穿是什么？什么解决方案。
5.binlog作用、redolog和undolog区别、reentrantlock是否重入、synchronized是否重入、非公平锁是什么意思、没获取到锁进入什么队列、cas如何解决aba问题等
6.volatile、https TLS协议过程、mysql隔离级别、mvcc
7.在2.5亿个整数中找出不重复的整数，内存不足以容纳这2.5亿个整数
mysql主从半同步
9.	数据库索引优化
10.	项目，redis/mysql有用过吗，怎么用的，分布式事务怎么用，分布式锁怎么实现。
11.	缓存：一致性、双删、缓存雪崩、穿透。项目：高可用建设。



热点问题产生的影响？
1、请求堆积，记账时间延长。
2、锁争用，争用失败会导致处理线程挂起。

在建设热点记账能力前，DB仅支持热点账户200TPS记账，无法满足实际业务诉求。

账务热点问题解决方案？
缓冲记账、合并记账

缓冲记账：
账户系统对于部分热点账户采取缓冲记账的策略，
即对于热点账户的加减币类的记账指令，账
务系统会先将记账指令缓冲入库，
然后先行返回记账成功，
后续再从数据库中拉取记账指令进行记账。

合并记账：
账户系统对于实时流量>150TPS的账户采取合并记账的策略，
即对于热点账户的加减币类的记账指令，
账务系统会先将记账指令按账户维度 放入阻塞队列，
等待一定时间/队列中的指令数满足要求后再执行批量记账，
一次性对账户余额进行变更，优化单账户记账热点问题。


MySQL 主从同步的模式同步半同步异步复制原理是什么？同步半同步异步复制说的是从库在主库上拉取 binlog 日志的模式。同步是主库写vlog。主库写 redo log，事务处于 prepare 状态，主库写binlog，然后从库拉取的 binlog 去回放。从库回放成功后返回给主库 Ark 确认。所有的从库都完成回放后，主库提交事务，这样是可以保证主从数据一致的。但是缺点就是速度太慢了。


为什么 b 加数会比 b 数更加优秀？ b 数是有序数组加平衡多差数。 b 加数是有序数组链条链表加平衡多叉树。 b 加树的关键字全部存放在叶子节点中，这样叶子结点，这样非叶子结点就能在相同的空间存储更多的信息。非叶子结点用来做索引，而叶子结点中有一个指针指向下一个叶子节点。做这个优化的目的是为了提高区间访问的性能，而正是这个特性决定了 b 加数更适合用来存储 Web 数据。


b 树的查询主要发生在内存中，而平衡二叉树的查询则是发生在磁盘读取中。因此，虽然 b 数查询的次数不比平衡二叉数的次数少，但是相比起磁盘 IO 速度，内存中比较的耗时就可以忽略不计了，因此 b 数更适合作为索引，比 b 树更适合作为索引的结构式 b 加树。 MySQL 中也是使用 b 加树作为索引，它是 b 树的变种，因此是基于 b 树来改进的。


MVCC 解决的问题，锁机制可以控制并发操作，但是系统开销比较大。而 MVCC 可以在大多数情况下代替航机锁，使用 MVCC 能降低系统的开销。


 加数为什么有利于磁盘IO？首先了解一下计算机的空间局部性原理。当一个数据被律被利用到的时候，其附近的数据也通常会马上被使用，即使只需要一个字节，磁盘也会从这个位置开始，顺序向后读取一定长度的数据放入内存。使用红黑树，也就是平衡二叉树结构的话，每次磁盘预读中的很多数据是用不上的数据，所以它没能利用好磁盘预读的提供的数据。然后又由于它的深度较大，这个深度是相较于 b 数而言的，所以进行的磁盘 IO 操作更多。 b 树的每个节点可以存储多个关键字，将节点大小设置为磁盘页的大小，充分利用了磁盘预读的功能。每次读取磁盘页时就会读取一整个节点，也正因为每个节点存储着非常多关键字树的深度就会非常的小，进而要执行的磁盘读取操作次数就会非常少，更多的是在内存中对读取进行的数据进行查找。


 b 加树的特点是什么？为什么要用这个数据结构？ b 加树是 b 树的变种，他们可以是 23 数、 234 数、二三四 5 数等等。当单个节点允许伸出 1, 200 个节点的时候，三层就可以有 17 亿，因此它的体型扁平，有利于磁盘IO。 b 加数，非叶子节点不存储数据， b 数是叶子节点存储数据，所以相同大小的数据块 b 加树是能够存储更多的索引。 b 加树叶子节点上有双向链表串联，有利于进行范围搜索。


MQ 消息必答，支持常见消息队列的消息投递，语义分为三种， at most once 消息可丢之，每个消息最多投递一次，存在生产方发送的消息，消费方收不到的情况。 at least once 消息必答指每个消息必须投递一次，消费方最少消费一次，一般有小概率出现重复消息，消费方需要做消息处理的幂等 exactly once 生产方发送的一条消息，消费方会收到消息，而且只会收到一次。这种消息投递语义实现成本较高，目前没有普适性的简单解决方案，上下游需要依赖较为完整的事务保证机制。一般而言，这三个消息投递于意，保障等级是逐个增强的，实现难度和运行开销也是逐个增强。综合考虑成本和业务需求， DDMQ 选择支持 at least once 消费语义，保证消息必达。





【稳定性】

稳定性 7 层架构图。稳定性有 7 层，从下到上分别是设施变更、评估、预警、感知、应急善后。先从最底层开始说，设施公司的设施要完善、稳定。第二层变更要规范。变更包括设计、研发代码规范、准入、准出、部署发布，这些设施包括机房、网络供电。这些评估是第三层评估，包括全链路压测、故障注入、场景分类、热点活动等等。第四层预警，包括哨兵巡检、容量、水位错误捕获。第五层感知，包括系统监控、 BI 监控、舆情监控、触达通道等等。第六层应急包括故障定位、降级、容灾资源伸缩、协作指挥。第七层善后包括影响核算、补救方案、数据修复、退款、补款等。稳定性的目的是降发生、促恢复。


【设计】

系统设计的思考？一、系统约束和假设。题正确的问题很重要，问题要围绕系统设计的关键核心点。比如下面的例子，一，谁使用它？有哪些角色的用户？谁有多少用户数？如何使用系统具备的功能？how？有多少QPS？



系统内部存储哪些数据？系统内部存储的数据逗号有多少？数据量？请求中读写比例，它决定了数据库的读写能力如何设计是否需要缓存等。


设计一个高层级的设计，画出系统架构图组件之间的连接。

设计核心组件的关键设计。四、扩展设计每个模块的瓶颈及解决方案配置的方式。比如文件或者 DB Redis 等分布式监控失败，重试使用队列多线程的情况下，问题如何处理？一致性模式弱一致性、强一致性最终一致性可用性模式故障切换、主从切换、双主切换。


资金清结算的流程：收集单据、算账、出账、结账。



收单：
单据从哪里获取，如何获取。单据一般是从相关上游系统获取。单据可以是同步、异步推送过来，做好补偿、核对即可。
实体信息从哪里获取，如何获取。
有些实体信息可以通过单据传过来，比如商品信息。
有些实体信息，需要查询来，比如商户信息通过商户系统查出来、用户信息通过用户系统查出来。
算账：
出账：
结账：



收单层的流程：商户入驻、签约产品、机构报件。
收单层的目标：为业务提供匹配其行业和目标商家群体的定制化收单解决方案。
收单层的解决方案：
结合业务特点，从场景、参与方的视角，制定“算账方式、出账方式、结账方式”相关的产品模式，并在客户入驻时，配置好“客户—结算产品”的关系，做好结算通道的合规报件。

收单层的指标：低成本、高效率、丰富的产品能力。
* 低成本：业务线仅需要小成本的接入后即可实现为其商家提供丰富的收单软硬件产品。除低成本接入收单软件服务外，对于收单硬件的产品及管理成本，该平台具有统一的设备管理服务，通过集采方式不断降低硬件成本的同时，为业务线提供数字化的硬件管理流程，实现硬件从厂商直发到指定销售渠道、数字化库存管理及财务记账能力。
* 高效率：为业务线提供页面级的商户入网服务，用差异化的商户入网标准及智能化的审核服务，实现30分钟入网成功商户占比达95%。
* 丰富的产品能力：为其商户群体提供收款高效、价格优惠、收款环节与美团生态高度融合的软硬件解决方案。



一致性事务

当一个事务操作需要跨多个节点的时候，为了保持事务处理的ACID特性，就需要引入一个“协调组（Coordinator）”。
协调组负责调度参与者的行为，并最终决定这些参与者是否要把事务真正进行提交。基于这个思想，就衍生出了二阶段提交和三阶段提交两种协议。
2PC
2PC是Two-Phase Commit的缩写，即二阶段提交。
目前绝大部分关系型数据库都是采用二阶段提交协议来完成分布式事务的处理，
利用该协议能够非常方便地完成所有分布式事务参与者的协调，
统一决定事务的提交或回滚，从而能够有效地保证分布式数据一致性。
2PC的过程比较简单，分为两个阶段：
1. 准备阶段。
2. 提交阶段。 
XA协议
通过MySQL XA实现了分布式事务。

不管是原始的2PC提交协议，还是XA协议，都存在一些问题：
* 在提交请求阶段，需要预留资源，在资源预留期间，其他人不能操作；
* 数据库是独立的系统。
因为上面这两点，不能根据业务特点弹性地调整锁的粒度，而这些都会影响数据库的并发性能。
所以才出现了TCC。

TCC
TCC （Try-Confirm-Cancel）事务模型采用的是补偿机制，核心思想是：针对每个操作，都要注册一个与其对应的确认和补偿操作。
TCC模型完全交由业务实现，每个子业务都需要实现Try-Confirm-Cancel三个接口，对业务侵入大，资源锁定交由业务方。
TCC分为三个阶段：Try是指预留。Confirm是指确认。Cancel是指撤销。 
TCC的难点不在于理解TCC的原理，而在于如何根据实际场景特点来实现预留、确认、撤销三个操作。
比如在转账的场景中，Try阶段就是冻结资金。Try阶段成功后，Confirm阶段就是执行真正的转账；若Try阶段失败，则执行Cnacel，如将冻结资金复位。

1. TCC是个业务层面的分布式事务协议，XA规范是数据层面的分布式事务协议，这也是TCC和XA规范最大的区别。
2. TCC与业务耦合紧密，在实际场景使用时，需要我们根据场景特点和业务逻辑来设计相应的预留、确认、撤销操作，相比MySQL XA，有一定的编程开发工作量。
3. 本质上而言，TCC是一种设计模式，也就是一种理念，它没有与任何技术（或实现）耦合，也不受限于任何技术，对所有的技术方案都是适用的。 
本地消息表
本地消息表方案应该是业界内使用最为广泛的，因为它使用简单，成本比较低。
核心思路是将分布式事务拆分成本地事务进行处理。
本地消息表与业务数据表处于同一个数据库中，
这样就能利用本地事务来保证在对这两个表的操作满足事务特性，
并且使用了消息队列来保证最终一致性。
其执行过程如下：
1. 上游处理完业务逻辑后，将业务数据和要下发的消息写入DB，同时发消息通知下游。
2. 下游获取消息后，处理自己的业务逻辑；处理成功后，给上游发送处理通知，并修改本地消息状态；
3. 上游有个定时任务，把未处理成功的消息，再次发送到消息中间件中；
缺点：
* 消息数据和业务数据耦合;
* 如果没有封装好的解决方案，会有很多杂活需要处理。

事务消息
消息事务的原理是将两个事务通过消息中间件进行异步解耦 ，
和本地消息表有点类似，但通过消息中间件的机制去做的，
其本质就是将本地消息表封装到了消息中间件中。
现在支持事务消息的消息中间件只有RocketMQ，这个概念最早也是RocketMQ提出的，
适用于所有对数据最终一致性需求的场景。通过事务消息实现分布式事务的流程如下：
* 发起方发送半事务消息会给RocketMQ ，此时消息的状态prepare，接受方还不能拉取到此消息；
* 半事务消息发送成功后，执行本地事务；
* 如果事务执行成功，则将消息commit，此时消费方能够接受到消息；
* 如果事务执行失败，则回滚，消息中间件将这条prepare消息删除；
* 如果事务参与方在执行完本地事务后宕机了
* 这就需要消息队列集群具备回查机制：如果收到半事务消息后，在特定时间内没有再收到确认消息，
* 会反过来请求事务参与方查询本地事务的执行状态，并给予反馈，决定是否将消息进行投递；
* 消费端接收到消息后进行消费，如果消费失败（如网络不稳定，没有接受到消息，后者下游宕机），
* 此时消息队列没有及时收到反馈，则会不断重试。 
事务消息的本质的借鉴了二阶段提交的思想，它跟本地消息表的做法也很像，
事务消息做的事情其实就是把消息表的存储和扫描消息表这两个事情放到消息中间件来做，使得消息表和业务表解耦。
这种方案也是实现了 最终一致性，对比本地消息表实现方案，不需要再建消息表，不再依赖本地数据库事务了，
所以这种方案更适用于高并发的场景。目前市面上实现该方案的只有阿里的RocketMQ。




收单
收集单据，最原始的POS收单，收集的是POS刷卡凭证，商家通过凭证去找收单机构结账。
百度百科的概念：收单机构向商户提供的本外币资金结算服务。

拆解并剖析 收单业务的概念：
收单机构 向 商户 提供 的 本外币 资金结算 服务。

战略制定，即：
What（什么是收单机构、商户、本外币、资金结算）、why（为什么这些，作用是什么）、how（各方的关系、如何获取商户、资金结算怎么做）
三层四面：行业大盘、线上大盘、字节大盘。客、量、额、利


战术制定：
收单的目的是为了将资金结算给商家。结算：谁给谁多少钱。
为了完成资金结算，收单服务需要收集相应的信息，根据信息，会决定如何结算资金。
这些信息一般存储在单据上、实体上。
单据包括：业务线订单、交易、退款、优惠、差错调整、赔付、扣费等。单据上包括支付方式、金额、币种、发卡行、收单行、用户ID、商户ID、商品ID等。
实体包括：
涉及参与分账的相关方，比如卖方的业务线和商户、配送方、收单机构等。
国内机构收单采用的是四方模式，涉及到发卡行，第三方收单机构，收单行，银联四方进行手续费分成。

分账是2次分账，
第1次分账：钱收到收单机构，收单机构跟发卡行，收单行，银联，四方分账。第1次分账在国际化支付做了，收取的通道费用。
第2次分账：收单机构给业务线、商家、配送方、保司等分账。第2次分账在电商业务侧。


资金清结算的流程：收集单据、算账、出账、结账。

收单：
单据从哪里获取，如何获取。单据一般是从相关上游系统获取。单据可以是同步、异步推送过来，做好补偿、核对即可。
实体信息从哪里获取，如何获取。
有些实体信息可以通过单据传过来，比如商品信息。
有些实体信息，需要查询来，比如商户信息通过商户系统查出来、用户信息通过用户系统查出来。
算账：
出账：
结账：

收单层的流程：商户入驻、签约产品、机构报件。
收单层的目标：为业务提供匹配其行业和目标商家群体的定制化收单解决方案。
收单层的解决方案：
结合业务特点，从场景、参与方的视角，制定“算账方式、出账方式、结账方式”相关的产品模式，并在客户入驻时，配置好“客户—结算产品”的关系，做好结算通道的合规报件。

收单层的指标：低成本、高效率、丰富的产品能力。
* 低成本：业务线仅需要小成本的接入后即可实现为其商家提供丰富的收单软硬件产品。除低成本接入收单软件服务外，对于收单硬件的产品及管理成本，该平台具有统一的设备管理服务，通过集采方式不断降低硬件成本的同时，为业务线提供数字化的硬件管理流程，实现硬件从厂商直发到指定销售渠道、数字化库存管理及财务记账能力。
* 高效率：为业务线提供页面级的商户入网服务，用差异化的商户入网标准及智能化的审核服务，实现30分钟入网成功商户占比达95%。
* 丰富的产品能力：为其商户群体提供收款高效、价格优惠、收款环节与美团生态高度融合的软硬件解决方案。 


商户入驻—配套系统：客户中心、商户中心、审核中心。
客户中心模块：客户管理、账号管理、打款单元管理。
商户中心模块：商户管理、商户查询、业务识别码管理、结算单元管理。
审核中心模块：机审/人审服务、信息审核等。

签约产品—配套系统：产品中心。产品包括收款产品、结算产品。
产品模块：产品上架、产品签约、产品配置。
合同模块：合同管理、合同签约、归档管理。
活动模块：活动管理、活动发布、活动审核。

机构报件—配套系统：报件中心。
模块：通道报件、设备报件、通道/设备变更。

商户中心的难点：1、查询qps极高、热点数据。
高峰期查询请求量超过6WQPS，接口平均耗时<50ms（可不说：全年系统请求成功率达到99.9997%）

商户中心的解法：隔离（核心/非核心场景流量隔离、客户商户数据隔离、分场景限流）、冷热分离（二级缓存、DB）、读写分离（DB一主九从一统计）
缓存同步和一致性保障：数据变更（DTS异步删除）、查询链路（缓存穿透DB补偿）、最终一致性（缓存过期）
缓存命中率提升：
1、过期策略优化，
1.1 缓存几种写入和过期，解法为在过期时间之后2小时内随机设置过期时间，
1.2 高峰期集中缓存失效，解法为二级缓存过期时间比一级缓存长100ms，100ms为查询数据库最大耗时；
2、缓存降级。一级缓存查询不到时，查询二级缓存。


产品中心的难点：1、资金产品的定义。2、配置变更的版本化

产品中心的解法：不重不漏，覆盖资金链路的各个客户相关的变量。
产品：产品涵盖收款方式（发卡行、收单行、支付方式）、结算方式
“收款方式”的划分：线上收款有APP支付、签约支付，线下收单是POS刷卡、主扫商家收款码，被扫付款码。
“结算方式”的划分维度：
按照结算场景划分：代收结算、补贴结算、佣金结算、产品结算、垫付回款。
按照结算币种划分：比如数币一笔结、两笔结。国内基本上是本币结算。对照国际化：两笔结 就相当于 外币收款外币结、一笔结 就相当于 外币收款本币结算等。
按照结算时效划分：实时结、周期结。
按照结算时效划分：分成、费率等是要素。

产品中心的解法：环境隔离、灰度、版本化方案参考MVCC
环境隔离：ST和prod数据库隔离，
灰度：按照机器、业务规则灰度
版本化：undo日志、灰度记录、业务

挑战：变更3板斧，可灰度，可观察，可应急
可分批生效	P0	配置可在ST/灰度/(产线1批、2批、3批)分批生效	
可快速回滚	P0	一旦配置出问题，可以有效回滚到之前版本	
可观察	P0	lion SDK有埋点监控	
可满足不同类型的分批需求	P1	例如按机器灰度/按流量灰度	
同一种场景的配置修改需要能够互斥	P2	不允许同时有多个对同一个场景的配置进行的修改	配置表增加字段changeId，标记正在变更中
弊端：只能回滚当前配置，不能连续回滚。


报件中心的难点：报件信息的合规要求多种多样。不同的机构要求不同。

报件中心的解法：策略模式，


凭证中心的难点：数据来源多样，且数据格式不统一。
凭证中心的解决方案：异步解耦+核对、结构化。


计费系统的难点：规则多样
计费系统的解决方案：可配置、可视化



分布式锁3种

1、基于数据库排他锁实现
select * for update
2、基于redis setnx实现
Setnx成功则抢占锁，执行完成后删除锁。
3、基于zookeeper实现
Zookeeper 实现的分布式锁存在一些缺陷。在性能上不如基于缓存（如Redis）实现的分布式锁。
因为每次在创建锁和释放锁的过程中，都要动态创建、销毁瞬时节点来实现锁功能。
Zookeeper 中创建和删除节点只能通过Leader节点来执行，然后将数据同步到集群中的其他节点。
分布式环境中难免存在网络抖动，导致客户端和 Zookeeper 集群之间的 session 连接中断，此时 Zookeeper 服务端以为客户端挂了，就会删除临时节点。其
他客户端就可以获取到分布式锁了，导致了同时获取锁的不一致问题。

加锁需要考虑3点：
加锁的维度、
加锁的粒度
要不要加锁



防重设计

1、前端，控制操作频率
2、分布式锁
3、解决重复写
解决重复写的方法：
悲观锁（select * for update）、
乐观锁（update set version= * where id = * and version = *）、
唯一约束(唯一健)
按照实现成本和效率，推荐排序为：乐观锁 > 唯一约束 > 悲观锁。


原子性、可见性、有序性

原子性：
把一个或者多个操作在CPU执行的过程中不被中断的特性称为原子性。
解决方案：锁

可见性：
一个线程对共享变量的修改，另外一个线程能够立刻看到，我们称为可见性。
解决方案：MVCC、

有序性：
解决方案：锁、



介绍

基本信息、优势、亮点经历、匹配度

【经历】您好，我有*年工作经验。曾在**做过**岗位。
【优势】*年后端研发工作，*年交易资金相关工作，曾主导过***项目，系统设计和开发，积累了**经验。
【行业思维】我一直在**领域深耕，对业务模式、系统链路上下游非常熟悉。
【匹配度】我有很好的沟通能力和组织协调能力，擅长统筹团队成员合作，完成***。能够设计总结可复用的系统能力、方法。








职业规划

表态+原因+行动计划

【表态】未来3年我希望通过在资金领域的积累，成长为一名业务能力优秀的行业专家，与公司一起在业务上不断精进迭代。
【原因】有2点，1、我看好这个方向的长期发展，2、我的能力模型和这个方向高度匹配。
【行动计划】为了更好的职业发展，我也有明确的自我提升计划。资金领域迭代很快，规则复杂。
如果叠加上各个国家、社会、商业这些因素，会更加有挑战。我会通过学习项目管理、团队管理的知识，应用到业务中，为公司做出更大贡献。




账户系统挑战

核心能力
查询类：为业务上游提供账户信息、账户状态、账户资金、操作明细、操作汇总等数据查询类服务。
管理类：为业务上游提供账户开立、账户状态变更、记账规则维护等管理类操作服务。
记账类：为业务上游提供账户资金的加币、减币、冻结、解冻等记账类的组合操作服务。
通知类：为业务下游提供数据同步、资金核算、资金监控、业务通知等通知类的实时处理服务。 
为什么会发生记账热点问题？
防止超花、加锁、顺序变更、串行操作，
因此业务高峰期频繁记账的账户就成了热点账户。

账户系统中为了防止"一钱多花"的问题，
在每次操作账户余额时需要对账户进行加锁，
确保每时每刻只有一个事务在更新余额。
加上变更余额的处理必须是顺序型变更，
上一次操作的结果会影响下一次操作的结果，
因此所有的操作都必须是串行操作。
在此背景下，业务高峰期频繁记账的账户将形成热点账户。

热点问题产生的影响？
1、请求堆积，记账时间延长。
2、锁争用，争用失败会导致处理线程挂起。

在建设热点记账能力前，DB仅支持热点账户200TPS记账，无法满足实际业务诉求。

账务热点问题解决方案？
缓冲记账、合并记账

缓冲记账：
账户系统对于部分热点账户采取缓冲记账的策略，
即对于热点账户的加减币类的记账指令，账
务系统会先将记账指令缓冲入库，
然后先行返回记账成功，
后续再从数据库中拉取记账指令进行记账。

合并记账：
账户系统对于实时流量>150TPS的账户采取合并记账的策略，
即对于热点账户的加减币类的记账指令，
账务系统会先将记账指令按账户维度 放入阻塞队列，
等待一定时间/队列中的指令数满足要求后再执行批量记账，
一次性对账户余额进行变更，优化单账户记账热点问题。





优惠券资金安全，事前预测，试算。事中，核销率 核销金额，低价订单，监测趋势 阈值。事后，一键降级预案




资金清结算的流程：收集单据、算账、出账、结账。

收单：
单据从哪里获取，如何获取。单据一般是从相关上游系统获取。单据可以是同步、异步推送过来，做好补偿、核对即可。
实体信息从哪里获取，如何获取。
有些实体信息可以通过单据传过来，比如商品信息。
有些实体信息，需要查询来，比如商户信息通过商户系统查出来、用户信息通过用户系统查出来。
算账：
出账：
结账：



收单层的流程：商户入驻、签约产品、机构报件。
收单层的目标：为业务提供匹配其行业和目标商家群体的定制化收单解决方案。
收单层的解决方案：
结合业务特点，从场景、参与方的视角，制定“算账方式、出账方式、结账方式”相关的产品模式，并在客户入驻时，配置好“客户—结算产品”的关系，做好结算通道的合规报件。

收单层的指标：低成本、高效率、丰富的产品能力。
* 低成本：业务线仅需要小成本的接入后即可实现为其商家提供丰富的收单软硬件产品。除低成本接入收单软件服务外，对于收单硬件的产品及管理成本，该平台具有统一的设备管理服务，通过集采方式不断降低硬件成本的同时，为业务线提供数字化的硬件管理流程，实现硬件从厂商直发到指定销售渠道、数字化库存管理及财务记账能力。
* 高效率：为业务线提供页面级的商户入网服务，用差异化的商户入网标准及智能化的审核服务，实现30分钟入网成功商户占比达95%。
* 丰富的产品能力：为其商户群体提供收款高效、价格优惠、收款环节与美团生态高度融合的软硬件解决方案。




商户入驻—配套系统：客户中心、商户中心、审核中心。
客户中心模块：客户管理、账号管理、打款单元管理。
商户中心模块：商户管理、商户查询、业务识别码管理、结算单元管理。
审核中心模块：机审/人审服务、信息审核等。

签约产品—配套系统：产品中心。产品包括收款产品、结算产品。
产品模块：产品上架、产品签约、产品配置。
合同模块：合同管理、合同签约、归档管理。
活动模块：活动管理、活动发布、活动审核。

机构报件—配套系统：报件中心。
模块：通道报件、设备报件、通道/设备变更。

商户中心的难点：查询qps极高、热点数据
业务线（场景）、代理商、商家、特约商户、保司。

商户中心的解决方案：


产品中心的难点：1、资金产品的定义。2、配置变更的版本化

产品中心的解法：不重不漏，覆盖资金链路的各个客户相关的变量。
产品：产品涵盖收款方式（发卡行、收单行、支付方式）、结算方式
“收款方式”的划分：线上收款有APP支付、签约支付，线下收单是POS刷卡、主扫商家收款码，被扫付款码。
“结算方式”的划分维度：
按照结算场景划分：代收结算、补贴结算、佣金结算、产品结算、垫付回款。
按照结算币种划分：比如数币一笔结、两笔结。国内基本上是本币结算。对照国际化：两笔结 就相当于 外币收款外币结、一笔结 就相当于 外币收款本币结算等。
按照结算时效划分：实时结、周期结。
按照结算时效划分：分成、费率等是要素。

产品中心的解法：


报件中心的难点：报件信息的合规要求。

报件中心的解法：


凭证中心的难点：数据来源多样，且数据格式不统一。
凭证中心的解决方案：异步解耦+核对、结构化、版本化。

计费系统的难点：规则多样
计费系统的解决方案：可配置、可视




配置化

数币的支付系统，向下对接网关（机构）、向上对接收银台。两头的需求变更比较多，中间的链路和系统保持稳定不变。

网关侧将不同机构的交互方式，按照用户交互次数分为（预下单支付、直接支付）、按照机构的响应时效（同步获取结果、异步查询结果）。
机构的模式确定后，按照交互方式，配置查询、重试、置终态的策略。

收银台侧的需求，不同支付方式，筛选、排序、推荐、样式等不同，策略配置。

交易系统基本没有需求。
数据记录信息全，是稳定的。只需要提供几个标准的查询接口。
系统的上下游交互模式，也是稳定的。

交易系统也可以按照这个思路，拆成对上、对下的2层，中间层保持不变。

通用、特殊的梳理出来，尽量将核心链路保持通用稳定。入口、出口层将特殊转化成通用，或者将特殊逻辑框在出口、入口层。




可扩展架构的基本思想和模式

一个字：拆。
三种拆的方式：
1、面向流程拆分，
2、面向服务拆分，
3、面向功能拆分。
基于系统的扩展方式，选择哪种拆分方式？有些系统会用到三种里面的两种。
比如零钱包创新，是按照功能拆分出来。收单模式，线上收单、线下收单 是按照流程拆分。

每种拆分方式下典型的架构有：
面向流程拆分：分层架构。比如，从购物车 到 交易 到 结算的流程。
面向服务拆分：微服务、SOA。
面向功能拆分：微内核架构。

架构设计的三个原则

架构设计的主要目的是为了解决软件系统复杂度带来的问题。
因此架构设计要遵循3个主要原则：
合适原则、简单原则、演化原则。
1、合适优于业界领先
如果不合适很容易失败的原因：
1）没有应用场景
2）人力成本
3）没有足够的经验，没有经历过相关的坑

2、简单优于复杂
系统复杂的3个方面，
1）结构复杂，模块较多，模块之间的互相关联增加了系统整体的风险。
比如创新探索性项目零钱包，有开卡、充值、退卡、还款，
这些功能散落在4-5个系统中，开发、联调、维护成本都增加
2）逻辑复杂，
还款，
3）算法复杂

3、演化优于一步到位。
防止过度设计，留好扩展口就行。


客户、商户、账户

客户：收款的个人或企业。是收单业务的签约主体和打款主体。
商户：商品交易等经营活动的单位、个体户、组织等。是结算主体。
账户：记账主体。


设计模式

常用的设计模式：
创建型模式（单例模式、工厂模式）
结构型模式（适配器模式、装饰模式）
行为型模式（责任链模式、迭代器模式）

报件中心的难点：报件信息的合规要求多种多样。不同的机构要求不同。
报件中心的解法：策略模式，



高并发--解法
负载均衡、
分布式缓存、
分布式消息队列是解决突发的高并发写操作问题和实现更简单的集群伸缩的一种常用技术方案。


资金安全：错、迟、重、漏


交易系统挑战


服务不是拆得越细越好，要结合团队的人力、公司的服务治理等基础服务情况来定。要做微服务，需要做到以下三点，一、建设好基础设施， RPC 服务治理、日志监控、持续集成、持续部署、运维自动化是最基本的，其他的包括服务编排、分布式追踪等。二、要逐步演进和迭代，不要过于激进，更不要拆分过细，拆分的力度要与团队的架构相互匹配。三、微服务与数据库方面是个很大的难点，可以深入了解下领域驱动设计，做好领域建模，特别是数据库要随着服务一起拆分。



系统复杂度的来源，一高性能。二高可用。 3 可扩展四业务复杂。其他系统复杂度带来的影响，认知负荷，协同成本。


系统设计分层。一般系统设计会分成三层。第一层，场景服务是解决细分市场的问题。第二层核心流程层是为了让系统能够扩展和定制。第三层存储层包括在线存储和离线分析。



数据模型存储要解决的问题是一向业务对齐，业务决定了存储的内容。二、事后可追溯，比如客服查询审计。数据模型的选择一以实体为中心，比如账户表，账户有一系列的属性，这些属性构成实体。二、以单据为中心，比如流水表账户之间的转账关系就是单据。3、以事件为中心，比如交易日志表账户变更日志表。时间对象动作组合起来就是一个事件。


账户系统难点

1、热点账户

2、分布式事务

3、账户数据表设计
1）账户表（包含余额、状态）
防篡改：关键字段加密，比如余额
2）账户流水表
幂等
3）账户日志变更表
可回溯

幂等：流水号
防改：链式设计、余额等关键字段通过新增加密字段来保存密文

热点账户解决方案热点账户
解决方案一，缓冲记账，将流水放到 MQ 中削峰
二、汇总记账，定时将一定时间内的流水合并成一条流水，更新到账户中
三、拆分子账户
四、 Redis 实时记录余额，异步更新到DB。


设计模式的本质就是封装变化。

数据模型并发控制，如果以单据或者事件为中心，方便 RPC 幂等防重入。如果以实体对象为中心，方便写规则，但是自身很难幂等账户表结构设计通过多表事务同时维护事件单据和实体对象的一致性更新，实现两者的兼得。有实体对象，没有单据不能实现重入幂等。比如打车金领取发放后期紧急加了 Redis 存储做幂等控制，有事件或者单据没有实体对象，不能很好地控制规则。比如司机最近两天的账期，如果不在司机实体上存入账金额，就要在事件表统计最近两天的入账金额。

数据模型存储要解决的问题是一向业务对齐，业务决定了存储的内容。二、事后可追溯，比如客服查询审计。数据模型的选择一以实体为中心，比如账户表，账户有一系列的属性，这些属性构成实体。二、以单据为中心，比如流水表账户之间的转账关系就是单据。3、以事件为中心，比如交易日志表账户变更日志表。时间对象动作组合起来就是一个事件。



工作方法

系统设计方法：
1、业务分析
1）如果是面向用户的上层业务系统，业务目标是要达到行业占比多少、领先的目标，要根据“三层四面”，分析业务策略，进而设计对应的系统的核心功能。
三层四面：3层 行业大盘、线上大盘、美团大盘，4面 人（客户数）、量（交易量/履约量）、额（交易额）、利（利润率）。
2）如果是底层的平台系统， 要根据“商业模式三要素”，
3要素：客户价值、核心能力、收费模式。

2、对标
对标（benchmark）是美团的基本方法论之一。太阳底下无新事，我们通常不会是第一个遇到某个问题的人，我们思考的多数问题前人已经思考过甚至解决过。因此遇到问题时，先想想有没有其他人遇到和解决过同样的问题，他们是怎么做的、结果如何。

对标有很多好处
1）帮助我们更快的学习如何解决问题。站在巨人的肩上，可以少走弯路。
2）可以衡量我们做得如何，是不是行业领先。比如，搞清楚行业做某件事的效率或成本，我们是否比同行更加高效、更低成本？
3）可以帮我们打开视野，避免井底之蛙、闭门造车的局限。

对标的时候，注意不要只限于熟悉的国内同行，不限于本国，也不限于本行业，而是要在"全世界、全行业、全领域"寻找对标学习对象。

对标举例：
1）业务策略设计，对标：收单业务面临长期发展方向选择时，分别参考了中国和美国收单市场第一名的公司，发现他们都从单纯收单逐步走向行业解决方法的发展道路。
2）机制/流程设计，对标：资金安全机制、应急处理流程



系统设计 5 层倒金字塔结构。需求也就是背景价值，也就是核心关切原则就是项目的前提约束，服务的前提约束，比如扩展性、复用性。实践是指最佳实践行业内的解决方案。方法就是结合自身的落地方案。






核心竞争力

执行力、积极主动、学习能力

执行力：
领导交办的事情会想尽各种办法达成，
过程中可能有很多波折，会各种PK，
但结果目标能达成。

积极主动：
对待各种任务会积极的去推动，
也能在主动推动的过程中，发现一些问题，
优化解决，得到更好的结果。

学习能力：
对待复杂的业务场景，
能够自己研究事件的来龙去脉，
能够比较准确的理解业务的逻辑并根据自己的方式转化到工作中。



【建业的相关项目说明】

资金链路项目介绍

【一句话竟清楚项目名称+成绩】
创新结算项目。
从0到1建设创新支付业务相关的收单资金链路，
不损伤商户入驻体验，不损害金融平台原有链路的稳定性。

【S-背景】
当时业务增长处于初期、上升期，我是收单资金域的负责人。
带领9个同学，组成收单资金团队。

【T-目标】
我们的目标是设计并开发出一套系统，
1、能让商户快速入网，
2、具备算清、结清的能力。
3、复用金融平台的成熟能力
4、在不影响金融平台稳定性的前提下，具备快速扩展的能力

【难点&挑战】2点
难点1：资金业务是什么样子的

多业务、多场景、多债务、多角色

多业务：解决方案不同不同，到家、到店、到综、打车、金融等
多场景：结算事项不同，点餐、会员储值、金融理财、保险、
多债务类型：资金流向不同，分润、返佣、收费、工资
多参与方角色：商户、代理商、劳务公司、保险公司、支付机构、收单行、发卡行、用户。

资金业务，抽象：因为什么、结给谁、什么钱、多少钱、什么时候结、结到哪、（why、who、what、how much、when、where）

因为什么：结算场景
结给谁：结算主体
什么钱：计费规则，如单笔按比例、单笔固定值等
多少钱：费用项，如应结款、手续费、分润费
什么时候结：结算周期，如S0（秒级）、D1（自然日）、T1（工作日）
结到哪：打款主体


难点2：资金业务的商户性质不同、合规要求不同、计费规则不同、结算规则不同、打款规则不同。
会导致系统变更频繁，影响系统、链路的稳定性，不能快速扩展，快速支持业务。


【A-行动】
对标到家、到店等业务的清结算体系建设。结合创新支付的业务发展，
复用金融平台的一部分平台能力，不影响金融平台其他系统的稳定性，又能支持创新业务的快速发展和扩展。

具体采取的策略是3点：链路和系统设计、分层、统一的业务身份识别码
1、收单资金链路和系统设计，
按照抽象的资金业务，划分到商户入网相关系统、凭证中心、计费系统、结算系统、打款系统、银行网关。

2、分3层，收单层、资金核心层、机构网关层。
收单层：将多变的业务逻辑上浮到收单层，
资金核心层：核心不变的底层能力沉淀到资金核心，
机构网关层：和银行机构相关的逻辑沉淀到机构网关层。

收单层聚焦于业务场景的快速支持，该层是多变的，侧重于效率；
资金核心层侧重于模型的迭代与支撑，该层是稳定少变的，侧重于稳定性。
机构网关层，将不同银行机构的打款逻辑统一收敛，对调用方提供标准能力。

通过分析可以发现该分层可以实现变与不变的分离，进而为系统稳定性建设和效率提升找到做功方向。

3、统一的收单业务身份。基于业务身份，可以实现的收单服务和资金规则的定制，驱动业务流程的运转。
业务身份定义，在整个资金链路上必须是唯一的，能实现业务间的隔离。
确定了业务身份之后，在资金链路的不同环节，就可以将业务流程与业务规则关联起来。

哪些可以上浮到收单层？
和业务身份相关的参数，比如结算场景、结算主体、计费规则、费用项、结算周期、打款主体。
不同的业务身份，这些参数不同。可以在商户入网时，统一配置和管理。


【R-结果】（多用数据对比）
交付效率：需求周期8天，金融平台13天，（快速交付）
稳定性：具备按业务、按通道快速降级的能力。
凭证单：日峰值300w
结算单：日峰值50w
商户数：120w
结算额：日峰值1.3亿